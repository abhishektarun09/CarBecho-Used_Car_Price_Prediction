{% extends "layout.html" %}

{% block title %}CarBecho - Prediction{% endblock %}

{% block main %}
<div class="container my-5">
    <div class="card shadow p-4 mx-auto" style="max-width: 700px;">
        <h2 class="text-center mb-4">Predict Your Car's Selling Price</h2>

        <form id="prediction-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="form-group">
                <label>Fuel</label>
                <select class="form-control" name="fuel" required>
                    <option selected disabled value="">Select Fuel Type</option>
                    <option value="Diesel">Diesel</option>
                    <option value="Petrol">Petrol</option>
                    <option value="LPG">LPG</option>
                    <option value="CNG">CNG</option>
                </select>
            </div>

            <div class="form-group">
                <label>Owner</label>
                <select class="form-control" name="owner" required>
                    <option selected disabled value="">Select Owner</option>
                    <option value="First Owner">First Owner</option>
                    <option value="Second Owner">Second Owner</option>
                    <option value="Third Owner">Third Owner</option>
                    <option value="Fourth & Above Owner">Fourth & Above Owner</option>
                </select>
            </div>

            <div class="form-group">
                <label>Seller Type</label>
                <select class="form-control" name="seller_type" required>
                    <option selected disabled value="">Select Seller Type</option>
                    <option value="Individual">Individual</option>
                    <option value="Dealer">Dealer</option>
                    <option value="Trustmark Dealer">Trustmark Dealer</option>
                </select>
            </div>

            <div class="form-group">
                <label>Transmission</label>
                <select class="form-control" name="transmission" required>
                    <option selected disabled value="">Select Transmission Type</option>
                    <option value="Manual">Manual</option>
                    <option value="Automatic">Automatic</option>
                </select>
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label>KMs Driven</label>
                    <input type="number" class="form-control" name="km_driven" placeholder="e.g. 30000" min="0" required>
                </div>
                <div class="form-group col-md-6">
                    <label>Mileage (kmpl)</label>
                    <input type="number" class="form-control" name="mileage" placeholder="e.g. 18.5" min="0" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label>Engine (CC)</label>
                    <input type="number" class="form-control" name="engine" placeholder="e.g. 1197" min="0" required>
                </div>
                <div class="form-group col-md-6">
                    <label>Max Power (bhp)</label>
                    <input type="number" class="form-control" name="max_power" placeholder="e.g. 90" min="0" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-md-6">
                    <label>Seats</label>
                    <input type="number" class="form-control" name="seats" placeholder="e.g. 5" min="1" required>
                </div>
                <div class="form-group col-md-6">
                    <label>Age</label>
                    <input type="number" class="form-control" name="age" placeholder="e.g. 3" min="0" required>
                </div>
            </div>

            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg mt-3">Predict Selling Price</button>
            </div>
        </form>
        <div id="result-card" class="card shadow text-center mx-auto mt-4 d-none"
            style="max-width: 500px; border-left: 5px solid #28a745;">
        <div class="card-body">
        <h4 class="card-title mb-3">Prediction Result</h4>
        <p class="card-text">
            Estimated selling price:
        </p>
        <h2 id="prediction-result" class="text-success font-weight-bold"></h2>
        <p class="mt-3 text-muted">
            This is an AI-powered estimate. Actual market prices may vary.
        </p>
    </div>
</div>

    </div>
</div>
<script>
document.addEventListener("DOMContentLoaded", function () {

    const form = document.getElementById("prediction-form");
    console.log("Form found:", form);

    form.addEventListener("submit", async function (e) {
        e.preventDefault();
        console.log("Submit clicked");

        const formData = new FormData(e.target);

        const payload = {
            km_driven: Number(formData.get("km_driven")),
            fuel: formData.get("fuel"),
            seller_type: formData.get("seller_type"),
            transmission: formData.get("transmission"),
            owner: formData.get("owner"),
            mileage: Number(formData.get("mileage")),
            engine: Number(formData.get("engine")),
            max_power: Number(formData.get("max_power")),
            seats: Number(formData.get("seats")),
            age: Number(formData.get("age"))
        };

        const response = await fetch("/api/v1/predict", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        });

        const data = await response.json();
        console.log("Response:", data);

        if (!response.ok) {
            alert(data.error || data.message);
            return;
        }

        document.getElementById("prediction-result").innerText =
            data.formatted_prediction;

        document.getElementById("result-card").classList.remove("d-none");
    });
});
</script>
{% endblock %}